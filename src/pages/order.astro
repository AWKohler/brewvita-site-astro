---
const SQUARE_VERSION = "2025-10-16";
const runtimeEnv = Astro.locals?.runtime?.env ?? {};
const getEnv = (key) => runtimeEnv[key] ?? import.meta.env[key];

const configuredSquareEnvironment = (
    getEnv("SQUARE_ENVIRONMENT") || ""
).toLowerCase();
const squareApplicationId =
    getEnv("SQUARE_APP_ID") || getEnv("PUBLIC_SQUARE_APP_ID") || "";
const squareAccessToken = getEnv("SQUARE_ACCESS_TOKEN");
const configuredLocationId = getEnv("SQUARE_LOCATION_ID");
const configuredOnlineMenuName = getEnv("SQUARE_ONLINE_MENU_NAME") || "Online Menu";

function resolveSquareEnvironment(explicitEnvironment, appId) {
    const hasSandboxAppId =
        typeof appId === "string" &&
        (appId.startsWith("sandbox-") || appId.includes("sq0idb-"));
    const hasProductionAppId =
        typeof appId === "string" && appId.includes("sq0idp-");

    if (hasSandboxAppId) return "sandbox";
    if (hasProductionAppId) return "production";
    if (explicitEnvironment === "production") return "production";
    return "sandbox";
}

const squareEnvironment = resolveSquareEnvironment(
    configuredSquareEnvironment,
    squareApplicationId,
);
const isProductionSquare = squareEnvironment === "production";
const SQUARE_API_BASE = isProductionSquare
    ? "https://connect.squareup.com"
    : "https://connect.squareupsandbox.com";
const FALLBACK_IMAGE = "/coffee/no_thumb.png";

const squareJsUrl = isProductionSquare
    ? "https://web.squarecdn.com/v1/square.js"
    : "https://sandbox.web.squarecdn.com/v1/square.js";

function isPresentAtLocation(catalogObject, locationId) {
    if (!catalogObject || !locationId) return true;

    const presentAtAll = catalogObject.present_at_all_locations ?? true;
    const presentIds = catalogObject.present_at_location_ids ?? [];
    const absentIds = catalogObject.absent_at_location_ids ?? [];

    if (absentIds.includes(locationId)) return false;
    if (presentAtAll) return true;
    return presentIds.includes(locationId);
}

function amountToDollars(amount) {
    return (Number(amount ?? 0) || 0) / 100;
}

function toInt(value, fallback = null) {
    const parsed = Number(value);
    if (!Number.isFinite(parsed)) return fallback;
    return Math.trunc(parsed);
}

function toBoolOverride(value) {
    const normalized = String(value || "NOT_SET").toUpperCase();
    if (normalized === "YES") return true;
    if (normalized === "NO") return false;
    return null;
}

function resolveAllowQuantities(listData, listInfo) {
    const override = toBoolOverride(listInfo?.allow_quantities_override);
    if (override !== null) return override;
    return Boolean(listData?.allow_quantities);
}

function resolveOnlineHidden(modifierData, modifierOverride) {
    const override = toBoolOverride(modifierOverride?.hidden_online_override);
    if (override !== null) return override;
    return Boolean(modifierData?.hidden_online);
}

function resolveOnByDefault(modifierData, modifierOverride) {
    const override = toBoolOverride(modifierOverride?.on_by_default_override);
    if (override !== null) return override;
    if (typeof modifierOverride?.on_by_default === "boolean") {
        return modifierOverride.on_by_default;
    }
    return Boolean(modifierData?.on_by_default);
}

function resolveMinSelected(rawValue, fallback = 0) {
    const parsed = toInt(rawValue, null);
    if (parsed === null || parsed === -1) return fallback;
    if (parsed < 0) return 0;
    return parsed;
}

function resolveMaxSelected(rawValue, fallback = null) {
    const parsed = toInt(rawValue, null);
    if (parsed === null || parsed === -1) return fallback;
    if (parsed <= 0) return null;
    return parsed;
}

function resolveModifierPriceAmount(modifierData, modifierOverride, locationId) {
    const overrideAmount = toInt(modifierOverride?.price_money?.amount, null);
    if (overrideAmount !== null) return overrideAmount;

    if (locationId && Array.isArray(modifierData?.location_overrides)) {
        const locationOverride = modifierData.location_overrides.find(
            (override) => override?.location_id === locationId,
        );
        const locationAmount = toInt(locationOverride?.price_money?.amount, null);
        if (locationAmount !== null) return locationAmount;
    }

    return toInt(modifierData?.price_money?.amount, 0) ?? 0;
}

function resolveOrdinal(...values) {
    for (const value of values) {
        const parsed = toInt(value, null);
        if (parsed !== null) return parsed;
    }
    return Number.MAX_SAFE_INTEGER;
}

function hasAssignedChannels(itemData) {
    return (
        Array.isArray(itemData?.channels) &&
        itemData.channels.some(
            (channelId) =>
                typeof channelId === "string" && channelId.trim().length > 0,
        )
    );
}

function isVisibleInOnlineMenu(itemData) {
    const ecomVisibility = String(itemData?.ecom_visibility || "").toUpperCase();
    if (ecomVisibility === "HIDDEN") return false;
    if (typeof itemData?.ecom_available === "boolean" && !itemData.ecom_available) {
        return false;
    }
    if (Boolean(itemData?.hidden_online)) return false;
    return true;
}

async function squareRequest(path, options = {}) {
    if (!squareAccessToken) {
        throw new Error(
            "Missing SQUARE_ACCESS_TOKEN. Configure it in your environment.",
        );
    }

    const response = await fetch(`${SQUARE_API_BASE}${path}`, {
        ...options,
        headers: {
            Authorization: `Bearer ${squareAccessToken}`,
            "Content-Type": "application/json",
            "Square-Version": SQUARE_VERSION,
            ...(options.headers ?? {}),
        },
    });

    const payload = await response.json();
    if (!response.ok) {
        const apiErrors = payload?.errors
            ?.map((error) => error?.detail || error?.code)
            ?.filter(Boolean)
            ?.join(", ");
        throw new Error(apiErrors || `Square API error (${response.status})`);
    }

    return payload;
}

async function resolveLocationId() {
    if (configuredLocationId) return configuredLocationId;

    const locationsPayload = await squareRequest("/v2/locations");
    const activeLocation = (locationsPayload.locations || []).find(
        (location) => location.status === "ACTIVE",
    );
    return activeLocation?.id || null;
}

async function fetchCatalogObjects() {
    const objects = [];
    const relatedObjects = [];

    let cursor = null;
    do {
        const payload = await squareRequest("/v2/catalog/search", {
            method: "POST",
            body: JSON.stringify({
                object_types: ["ITEM"],
                include_related_objects: true,
                limit: 100,
                ...(cursor ? { cursor } : {}),
            }),
        });

        if (payload.objects?.length) objects.push(...payload.objects);
        if (payload.related_objects?.length) {
            relatedObjects.push(...payload.related_objects);
        }

        cursor = payload.cursor || null;
    } while (cursor);

    return { objects, relatedObjects };
}

async function fetchCategoryObjects() {
    const categories = [];
    let cursor = null;
    do {
        const payload = await squareRequest("/v2/catalog/search", {
            method: "POST",
            body: JSON.stringify({
                object_types: ["CATEGORY"],
                include_related_objects: false,
                limit: 100,
                ...(cursor ? { cursor } : {}),
            }),
        });

        if (payload.objects?.length) {
            categories.push(...payload.objects);
        }
        cursor = payload.cursor || null;
    } while (cursor);

    return categories;
}

async function fetchMenuItems(locationId) {
    const menuItems = [];
    let cursor = null;
    try {
        do {
            const payload = await squareRequest("/v2/catalog/search", {
                method: "POST",
                body: JSON.stringify({
                    object_types: ["MENU_ITEM"],
                    include_related_objects: false,
                    limit: 100,
                    ...(cursor ? { cursor } : {}),
                }),
            });
            const pageMenuItems = Array.isArray(payload?.objects)
                ? payload.objects
                : [];
            pageMenuItems.forEach((menuItemObject) => {
                if (menuItemObject?.type !== "MENU_ITEM") return;
                if (menuItemObject?.is_deleted) return;
                if (!isPresentAtLocation(menuItemObject, locationId)) return;
                menuItems.push(menuItemObject);
            });
            cursor = payload?.cursor || null;
        } while (cursor);
    } catch {
        return [];
    }
    return menuItems;
}

async function fetchLocationChannelIds(locationId) {
    if (!locationId) return [];
    if (!isProductionSquare) return [];

    const channelIds = [];
    let cursor = null;
    try {
        do {
            const query = new URLSearchParams({
                reference_type: "LOCATION",
                reference_id: locationId,
                status: "ACTIVE",
            });
            if (cursor) {
                query.set("cursor", cursor);
            }
            const payload = await squareRequest(`/v2/channels?${query.toString()}`);
            const channels = Array.isArray(payload?.channels) ? payload.channels : [];
            channels.forEach((channel) => {
                if (channel?.status !== "ACTIVE") return;
                if (channel?.reference?.type !== "LOCATION") return;
                if (channel?.reference?.id !== locationId) return;
                if (typeof channel?.id !== "string" || !channel.id.length) return;
                channelIds.push(channel.id);
            });
            cursor = payload?.cursor || null;
        } while (cursor);
    } catch {
        return [];
    }

    return Array.from(new Set(channelIds));
}

function normalizeMenuFromCatalog(
    catalogObjects,
    relatedCatalogObjects,
    categoryObjects,
    locationId,
    locationChannelIds = [],
    menuItems = [],
    targetMenuName = "",
) {
    const allObjects = [...catalogObjects, ...relatedCatalogObjects, ...categoryObjects];
    const categoriesById = new Map();
    const imagesById = new Map();
    const modifierListsById = new Map();

    for (const object of allObjects) {
        if (object.type === "CATEGORY") {
            categoriesById.set(object.id, {
                id: object.id,
                name: object.category_data?.name || "Uncategorized",
                categoryType: object.category_data?.category_type || "REGULAR_CATEGORY",
                onlineVisibility: object.category_data?.online_visibility,
                parentCategoryId: object.category_data?.parent_category?.id || null,
                rootCategoryId: object.category_data?.root_category || null,
                isTopLevel: Boolean(object.category_data?.is_top_level),
                channels: Array.isArray(object.category_data?.channels)
                    ? object.category_data.channels.filter(
                          (channelId) =>
                              typeof channelId === "string" && channelId.length > 0,
                      )
                    : [],
            });
        }
        if (object.type === "IMAGE") {
            imagesById.set(object.id, object.image_data?.url || FALLBACK_IMAGE);
        }
        if (object.type === "MODIFIER_LIST") {
            modifierListsById.set(object.id, object.modifier_list_data || {});
        }
    }

    const groupedByCategory = new Map();
    const itemObjects = catalogObjects.filter(
        (catalogObject) => catalogObject.type === "ITEM",
    );
    const hasMenuCategories = Array.from(categoriesById.values()).some(
        (category) => category.categoryType === "MENU_CATEGORY",
    );
    const locationChannelSet = new Set(locationChannelIds);
    const isMenuCategoryVisibleForLocation = (categoryId) => {
        const category = categoriesById.get(categoryId);
        if (!category) return false;
        if (category.categoryType !== "MENU_CATEGORY") return false;
        if (category.onlineVisibility !== true) return false;
        if (!category.channels.length) return false;
        if (!locationChannelSet.size) return true;
        return category.channels.some((channelId) => locationChannelSet.has(channelId));
    };
    const visibleMenuCategories = Array.from(categoriesById.values())
        .filter((category) => category.categoryType === "MENU_CATEGORY")
        .filter((category) => isMenuCategoryVisibleForLocation(category.id));
    const visibleMenuCategoryIds = new Set(
        visibleMenuCategories.map((category) => category.id),
    );
    const menuRootCandidates = visibleMenuCategories
        .filter(
            (category) =>
                category.isTopLevel ||
                !category.parentCategoryId ||
                !visibleMenuCategoryIds.has(category.parentCategoryId),
        )
        .map((category) => category.id);
    const normalizedTargetMenuName = String(targetMenuName || "")
        .trim()
        .toLowerCase();
    const matchingRootIds = normalizedTargetMenuName
        ? Array.from(categoriesById.values())
            .filter((category) => menuRootCandidates.includes(category.id))
            .filter(
                (category) =>
                    String(category.name || "").trim().toLowerCase()
                    === normalizedTargetMenuName,
            )
            .map((category) => category.id)
        : [];
    const selectedRootIds = new Set(
        matchingRootIds.length ? matchingRootIds : menuRootCandidates,
    );
    const allowedMenuCategoryIds = new Set(
        visibleMenuCategories
            .filter((category) => {
                const rootId =
                    category.rootCategoryId ||
                    (category.isTopLevel ? category.id : null);
                if (!selectedRootIds.size) return true;
                if (rootId && selectedRootIds.has(rootId)) return true;
                return selectedRootIds.has(category.id);
            })
            .map((category) => category.id),
    );
    const menuLinkedItemIds = new Set();
    const menuItemCategoryIdsByItemId = new Map();
    menuItems.forEach((menuItemObject) => {
        const menuItemData = menuItemObject?.menu_item_data || {};
        const linkedItemId =
            typeof menuItemData?.item_id === "string" ? menuItemData.item_id : "";
        if (!linkedItemId) return;
        const menuCategoryId =
            typeof menuItemData?.category_id === "string"
                ? menuItemData.category_id
                : "";
        if (allowedMenuCategoryIds.size) {
            if (!menuCategoryId) return;
            if (!allowedMenuCategoryIds.has(menuCategoryId)) return;
        }
        menuLinkedItemIds.add(linkedItemId);
        if (menuCategoryId) {
            if (!menuItemCategoryIdsByItemId.has(linkedItemId)) {
                menuItemCategoryIdsByItemId.set(linkedItemId, new Set());
            }
            menuItemCategoryIdsByItemId.get(linkedItemId).add(menuCategoryId);
        }
    });
    const catalogUsesItemChannels = itemObjects.some((itemObject) =>
        hasAssignedChannels(itemObject.item_data),
    );

    for (const itemObject of itemObjects) {
        if (itemObject?.is_deleted) continue;
        if (!isPresentAtLocation(itemObject, locationId)) continue;
        if (menuLinkedItemIds.size && !menuLinkedItemIds.has(itemObject.id)) continue;

        const itemData = itemObject.item_data || {};
        if (itemData?.is_archived) continue;
        if (!isVisibleInOnlineMenu(itemData)) continue;
        if (catalogUsesItemChannels && !hasAssignedChannels(itemData)) continue;

        const variations = (itemData.variations || [])
            .filter(
            (variation) =>
                variation.type === "ITEM_VARIATION" &&
                !variation?.is_deleted &&
                isPresentAtLocation(variation, locationId) &&
                variation.item_variation_data?.sellable !== false,
            )
            .filter((variation) => {
                const variationData = variation.item_variation_data || {};
                if (variationData.pricing_type !== "FIXED_PRICING") return false;
                return Number(variationData.price_money?.amount || 0) > 0;
            })
            .sort((a, b) => {
                const aOrdinal = resolveOrdinal(a.item_variation_data?.ordinal);
                const bOrdinal = resolveOrdinal(b.item_variation_data?.ordinal);
                if (aOrdinal !== bOrdinal) return aOrdinal - bOrdinal;
                const aName = String(a.item_variation_data?.name || "");
                const bName = String(b.item_variation_data?.name || "");
                return aName.localeCompare(bName);
            });
        if (!variations.length) continue;

        const primaryVariation =
            variations.find(
                (variation) =>
                    /regular/i.test(variation.item_variation_data?.name || ""),
            ) || variations[0];
        const variationData = primaryVariation.item_variation_data || {};

        const basePrice = amountToDollars(variationData.price_money?.amount);
        const itemCategoryRefs = [];
        const menuItemCategoryIds = Array.from(
            menuItemCategoryIdsByItemId.get(itemObject.id) || [],
        );
        menuItemCategoryIds.forEach((categoryId, index) => {
            itemCategoryRefs.push({
                id: categoryId,
                ordinal: -1000 + index,
            });
        });
        if (Array.isArray(itemData.categories)) {
            itemData.categories.forEach((categoryRef) => {
                if (typeof categoryRef?.id !== "string" || !categoryRef.id.length) return;
                itemCategoryRefs.push({
                    id: categoryRef.id,
                    ordinal: resolveOrdinal(categoryRef?.ordinal),
                });
            });
        }
        if (typeof itemData.category_id === "string" && itemData.category_id.length) {
            itemCategoryRefs.push({
                id: itemData.category_id,
                ordinal: Number.MAX_SAFE_INTEGER,
            });
        }
        itemCategoryRefs.sort((a, b) => a.ordinal - b.ordinal);

        const categoryIds = Array.from(
            new Set(itemCategoryRefs.map((categoryRef) => categoryRef.id)),
        );
        let resolvedCategory = null;
        if (hasMenuCategories && allowedMenuCategoryIds.size) {
            resolvedCategory =
                categoryIds
                    .map((categoryId) => categoriesById.get(categoryId))
                    .find((category) =>
                        category && allowedMenuCategoryIds.has(category.id),
                    ) || null;
            if (!resolvedCategory) continue;
        } else if (hasMenuCategories) {
            resolvedCategory =
                categoryIds
                    .map((categoryId) => categoriesById.get(categoryId))
                    .find((category) =>
                        category && isMenuCategoryVisibleForLocation(category.id),
                    ) || null;
            if (!resolvedCategory) continue;
        } else {
            resolvedCategory =
                categoryIds
                    .map((categoryId) => categoriesById.get(categoryId))
                    .find((category) => category && category.onlineVisibility !== false) ||
                null;
        }
        const categoryName = resolvedCategory?.name || "Uncategorized";

        const imageId =
            itemData.image_ids?.[0] ||
            itemData.image_id ||
            variationData.image_ids?.[0] ||
            variationData.image_id ||
            null;
        const imageUrl = (imageId && imagesById.get(imageId)) || FALLBACK_IMAGE;

        const modifierGroups = (itemData.modifier_list_info || [])
            .filter((listInfo) => listInfo?.enabled !== false)
            .map((listInfo) => {
                const listData =
                    modifierListsById.get(listInfo.modifier_list_id) || {};
                const listHiddenOverride = toBoolOverride(
                    listInfo?.hidden_online_override,
                );
                const isListHiddenOnline =
                    listHiddenOverride === true ||
                    (listHiddenOverride === null &&
                        Boolean(listData?.hidden_online));
                if (isListHiddenOnline) return null;

                const modifierOverridesById = new Map(
                    (listInfo.modifier_overrides || [])
                        .filter((override) => override?.modifier_id)
                        .map((override) => [override.modifier_id, override]),
                );
                const options = (listData.modifiers || [])
                    .filter((modifier) => isPresentAtLocation(modifier, locationId))
                    .filter((modifier) => {
                        const override = modifierOverridesById.get(modifier.id);
                        return !override?.deleted;
                    })
                    .filter((modifier) => {
                        const override = modifierOverridesById.get(modifier.id);
                        return !resolveOnlineHidden(modifier.modifier_data, override);
                    })
                    .map((modifier) => {
                        const modifierData = modifier.modifier_data || {};
                        const override = modifierOverridesById.get(modifier.id) || {};
                        const priceAmount = resolveModifierPriceAmount(
                            modifierData,
                            override,
                            locationId,
                        );
                        return {
                            id: modifier.id,
                            name: modifierData.name || "Option",
                            priceAdjustment: amountToDollars(priceAmount),
                            onByDefault: resolveOnByDefault(modifierData, override),
                            sourceType: "MODIFIER",
                            ordinal: resolveOrdinal(
                                modifierData.ordinal,
                                override.ordinal,
                            ),
                        };
                    })
                    .sort((a, b) => {
                        if (a.ordinal !== b.ordinal) return a.ordinal - b.ordinal;
                        return a.name.localeCompare(b.name);
                    });
                if (!options.length) return null;

                const allowQuantities = resolveAllowQuantities(listData, listInfo);
                const selectionType = String(listData.selection_type || "")
                    .toUpperCase();

                const baseMin = resolveMinSelected(
                    listData.min_selected_modifiers,
                    0,
                );
                const baseMax = resolveMaxSelected(
                    listData.max_selected_modifiers,
                    null,
                );
                let minSelected = resolveMinSelected(
                    listInfo.min_selected_modifiers,
                    baseMin,
                );
                let maxSelected = resolveMaxSelected(
                    listInfo.max_selected_modifiers,
                    baseMax,
                );

                if (!allowQuantities) {
                    minSelected = Math.min(minSelected, options.length);
                    if (maxSelected === null) {
                        maxSelected = options.length;
                    } else {
                        maxSelected = Math.min(maxSelected, options.length);
                    }
                }

                if (maxSelected !== null && maxSelected < minSelected) {
                    maxSelected = minSelected;
                }

                const isSingle =
                    !allowQuantities &&
                    (selectionType === "SINGLE" || maxSelected === 1);

                return {
                    id: listInfo.modifier_list_id,
                    name: listData.name || "Options",
                    required: minSelected > 0,
                    minSelected,
                    maxSelected,
                    allowQuantities,
                    isSingle,
                    ordinal: resolveOrdinal(listInfo.ordinal, listData.ordinal),
                    options,
                };
            })
            .filter(Boolean)
            .sort((a, b) => {
                if (a.ordinal !== b.ordinal) return a.ordinal - b.ordinal;
                return a.name.localeCompare(b.name);
            })
            .map(({ ordinal, ...group }) => group);

        const hasSizeGroup = modifierGroups.some((group) =>
            /size/i.test(group.name),
        );
        if (!hasSizeGroup && variations.length > 1) {
            modifierGroups.unshift({
                id: "__variation__",
                name: "Size",
                required: true,
                minSelected: 1,
                maxSelected: 1,
                allowQuantities: false,
                isSingle: true,
                options: variations.map((variation) => {
                    const variationPrice = amountToDollars(
                        variation.item_variation_data?.price_money?.amount,
                    );
                    return {
                        id: variation.id,
                        variationId: variation.id,
                        name: variation.item_variation_data?.name || "Option",
                        priceAdjustment: variationPrice - basePrice,
                        onByDefault: variation.id === primaryVariation.id,
                        sourceType: "VARIATION",
                    };
                }),
            });
        }

        const item = {
            id: itemObject.id,
            name: itemData.name || "Unnamed Item",
            price: basePrice,
            desc: itemData.description || "",
            img: imageUrl,
            variationId: primaryVariation.id,
            modifierGroups,
        };

        if (!groupedByCategory.has(categoryName)) {
            groupedByCategory.set(categoryName, []);
        }
        groupedByCategory.get(categoryName).push(item);
    }

    return Array.from(groupedByCategory.entries()).map(([category, items]) => ({
        category,
        items,
    }));
}

let squareLocationId = configuredLocationId || null;
let menu = [];
let menuLoadError = "";

try {
    squareLocationId = await resolveLocationId();
    const locationChannelIds = await fetchLocationChannelIds(squareLocationId);
    const menuItems = await fetchMenuItems(squareLocationId);
    const { objects, relatedObjects } = await fetchCatalogObjects();
    const categoryObjects = await fetchCategoryObjects();
    menu = normalizeMenuFromCatalog(
        objects,
        relatedObjects,
        categoryObjects,
        squareLocationId,
        locationChannelIds,
        menuItems,
        configuredOnlineMenuName,
    );
} catch (error) {
    menuLoadError =
        error instanceof Error ? error.message : "Unable to load menu.";
}
---
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <title>Brewvita | Order Online</title>
        <link rel="icon" href="/favicon.ico" sizes="any" />
        <script src="https://cdn.tailwindcss.com" is:inline></script>
        <script src={squareJsUrl}></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap"
            rel="stylesheet"
        />
        <script is:inline>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            ink: "#1f2327",
                            slate: "#2a3d52",
                            mist: "#b8cde6",
                            fog: "#d9e6f5",
                            navy: "#152433",
                            "img-bg": "#96c2e8",
                        },
                        fontFamily: {
                            sans: ['"Space Grotesk"', "sans-serif"],
                            mono: ['"Space Mono"', "monospace"],
                        },
                        boxShadow: {
                            hard: "4px 4px 0px 0px #152433",
                            "hard-sm": "2px 2px 0px 0px #152433",
                        },
                    },
                },
            };
        </script>
        <style>
            :root {
                --safe-top: env(safe-area-inset-top, 0px);
            }

            .order-shell {
                min-height: 100vh;
                min-height: 100dvh;
            }

            .safe-top {
                padding-top: calc(var(--safe-top) + 0.5rem);
            }

            .ios-scroll {
                -webkit-overflow-scrolling: touch;
            }

            .checkout-drawer-top {
                top: calc(var(--safe-top) + 2rem);
            }

            .product-drawer-top {
                top: calc(var(--safe-top) + 3rem);
            }

            :global(messages-plugin) {
                --messages-offset-bottom: calc(
                    20px + env(safe-area-inset-bottom, 0px)
                );
                --button-border-radius: 999px;
                --button-medium-size-minimum-height: 52px;
                --button-medium-size-text-font-family:
                    "Space Grotesk",
                    sans-serif;
                --button-medium-size-text-weight: 700;
                --button-medium-size-text-size: 18px;
                --button-medium-size-text-leading: 24px;
                --button-normal-variant-tertiary-rank-normal-state-background-color: #ffffff;
                --button-normal-variant-tertiary-rank-normal-state-label-color: #152433;
                --button-normal-variant-tertiary-rank-hover-state-background-color: #d9e6f5;
                --button-normal-variant-tertiary-rank-hover-state-label-color: #152433;
                --button-normal-variant-tertiary-rank-pressed-state-background-color: #b8cde6;
                --button-normal-variant-tertiary-rank-pressed-state-label-color: #152433;
                --button-normal-variant-tertiary-rank-normal-state-light-mode-background-color: #ffffff;
                --button-normal-variant-tertiary-rank-normal-state-light-mode-label-color: #152433;
                --button-normal-variant-tertiary-rank-hover-state-light-mode-background-color: #d9e6f5;
                --button-normal-variant-tertiary-rank-hover-state-light-mode-label-color: #152433;
                --button-normal-variant-tertiary-rank-pressed-state-light-mode-background-color: #b8cde6;
                --button-normal-variant-tertiary-rank-pressed-state-light-mode-label-color: #152433;
            }

            :global(messages-plugin::part(popover)) {
                right: 16px !important;
                bottom: var(--messages-offset-bottom) !important;
                z-index: 48 !important;
                transition:
                    bottom 220ms ease,
                    opacity 180ms ease,
                    transform 180ms ease;
            }

            :global(body.messages-shifted messages-plugin) {
                --messages-offset-bottom: calc(
                    104px + env(safe-area-inset-bottom, 0px)
                );
            }

            :global(body.messages-hidden messages-plugin::part(popover)) {
                opacity: 0 !important;
                pointer-events: none !important;
                transform: translateY(12px);
            }

            .border-hard {
                border: 3px solid #152433;
            }
            .hide-scroll::-webkit-scrollbar {
                display: none;
            }
            .hide-scroll {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            /* Smooth category selection */
            .category-btn.active {
                background-color: #152433;
                color: #b8cde6;
                box-shadow: 2px 2px 0px 0px #1f2327;
            }

            /* Modal Animation */
            .modal-enter {
                transform: translateY(100%);
            }
            .modal-active {
                transform: translateY(0);
            }

            /* Remove thumbnail tinting on mobile for clearer drink photos */
            @media (max-width: 767px) {
                .drink-thumb {
                    mix-blend-mode: normal;
                }
            }
        </style>
    </head>
    <body
        class="order-shell bg-fog text-navy font-sans antialiased overflow-x-hidden"
    >
        <div id="order-sticky-header" class="sticky top-0 z-50">
            <!-- Conceptual Anchor: Location Context -->
            <div
                class="safe-top bg-navy text-mist px-4 py-2 flex justify-between items-center text-xs font-mono border-b-4 border-slate"
            >
                <div class="flex items-center gap-2">
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                        ></path>
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                        ></path>
                    </svg>
                    <span class="uppercase tracking-wide">Pickup: Green Hall</span>
                </div>
                <a
                    href="/"
                    class="hover:text-white underline decoration-2 decoration-mist"
                    >Close</a
                >
            </div>

            <!-- Product Discovery: Categories -->
            <div
                class="bg-white border-b-4 border-navy py-4 overflow-x-auto hide-scroll shadow-sm"
            >
                <div class="flex gap-4 px-4 min-w-max" id="category-nav">
                    <!-- Populated via JS -->
                </div>
            </div>
        </div>

        <!-- Main Content: Product List -->
        <main
            class="ios-scroll pb-32 px-4 pt-6"
            id="menu-container"
        >
            <!-- Populated via JS -->
        </main>

        <!-- Cart Floating Anchor (Empty State / Active State) -->
        <div
            id="cart-bar"
            class="fixed bottom-0 left-0 w-full bg-white border-t-4 border-navy p-4 transform translate-y-full transition-transform duration-300 z-50 shadow-[0_-4px_10px_rgba(0,0,0,0.1)]"
        >
            <div class="max-w-2xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div
                        class="bg-navy text-mist w-10 h-10 flex items-center justify-center font-bold font-mono border-2 border-black"
                        id="cart-count"
                    >
                        0
                    </div>
                    <div class="flex flex-col">
                        <span class="text-xs uppercase font-bold text-slate"
                            >Current Total</span
                        >
                        <span
                            class="font-mono font-bold text-lg"
                            id="cart-total"
                            >$0.00</span
                        >
                    </div>
                </div>
                <button
                    id="review-order-btn"
                    class="bg-mist text-navy border-hard rounded-full px-6 py-3 font-bold uppercase shadow-hard-sm active:translate-y-1 active:shadow-none transition-all"
                >
                    Review Order
                </button>
            </div>
        </div>

        <!-- Checkout Drawer -->
        <div id="checkout-modal" class="fixed inset-0 z-[70] hidden">
            <div
                id="checkout-backdrop"
                class="absolute inset-0 bg-navy/80 backdrop-blur-sm transition-opacity opacity-0"
            ></div>
            <div
                id="checkout-content"
                class="checkout-drawer-top absolute inset-x-0 bottom-0 md:top-auto md:bottom-auto md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[520px] md:max-h-[90vh] bg-white border-t-4 md:border-4 border-navy flex flex-col transition-transform duration-300 transform translate-y-full md:translate-y-0 md:scale-95 opacity-0 rounded-t-xl md:rounded-none md:shadow-[8px_8px_0px_0px_#152433]"
            >
                <div class="flex justify-between items-center p-4 border-b-4 border-navy bg-fog shrink-0">
                    <h3 class="font-bold uppercase text-lg">Checkout</h3>
                    <button
                        id="checkout-close-btn"
                        class="w-8 h-8 flex items-center justify-center border-2 border-navy hover:bg-navy hover:text-white transition-colors font-mono font-bold"
                    >
                        X
                    </button>
                </div>

                <div class="overflow-y-auto flex-1 p-6 space-y-6">
                    <div>
                        <h4 class="font-bold uppercase text-xs tracking-widest text-slate mb-3">
                            Order Summary
                        </h4>
                        <div id="checkout-items" class="space-y-2"></div>
                        <div class="flex justify-between items-center border-t-2 border-navy mt-4 pt-3">
                            <span class="font-bold uppercase text-sm">Total</span>
                            <span id="checkout-total" class="font-mono font-bold text-lg">$0.00</span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h4 class="font-bold uppercase text-xs tracking-widest text-slate">
                            Payment Card
                        </h4>
                        <input
                            id="checkout-email"
                            type="email"
                            placeholder="Email for receipt (optional)"
                            class="w-full border-2 border-navy px-3 py-2 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-mist"
                        />
                        <div
                            id="card-container"
                            class="border-hard p-3 min-h-20 bg-fog"
                        ></div>
                        <p id="checkout-status" class="font-mono text-xs text-slate"></p>
                    </div>
                </div>

                <div class="p-4 border-t-4 border-navy bg-white shrink-0">
                    <button
                        id="pay-now-btn"
                        class="w-full bg-mist text-navy border-hard rounded-full py-4 font-bold uppercase text-lg shadow-hard-sm hover:shadow-hard hover:-translate-y-1 transition-all flex justify-between px-8"
                    >
                        <span>Pay Now</span>
                        <span id="pay-now-total">$0.00</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Product Detail View (Modal) -->
        <div id="product-modal" class="fixed inset-0 z-[60] hidden">
            <!-- Backdrop -->
            <div
                class="absolute inset-0 bg-navy/80 backdrop-blur-sm transition-opacity opacity-0"
                id="modal-backdrop"
                onclick="closeModal()"
            ></div>

            <!-- Drawer -->
            <div
                class="product-drawer-top absolute inset-x-0 bottom-0 md:top-auto md:bottom-auto md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[500px] md:h-auto md:max-h-[90vh] bg-white border-t-4 md:border-4 border-navy flex flex-col transition-transform duration-300 transform translate-y-full md:translate-y-0 md:scale-95 opacity-0 rounded-t-xl md:rounded-none md:shadow-[8px_8px_0px_0px_#152433]"
                id="modal-content"
            >
                <!-- Modal Header -->
                <div
                    class="flex justify-between items-center p-4 border-b-4 border-navy bg-fog shrink-0"
                >
                    <h3
                        class="font-bold uppercase text-lg truncate pr-4"
                        id="modal-title"
                    >
                        Product Name
                    </h3>
                    <button
                        onclick="closeModal()"
                        class="w-8 h-8 flex items-center justify-center border-2 border-navy hover:bg-navy hover:text-white transition-colors font-mono font-bold"
                    >
                        X
                    </button>
                </div>

                <!-- Modal Body (Scrollable) -->
                <div class="overflow-y-auto flex-1 p-6">
                    <!-- Image -->
                    <div
                        class="w-full aspect-square bg-img-bg border-hard mb-6 relative overflow-hidden group"
                    >
                        <img
                            id="modal-img"
                            src=""
                            alt="Drink"
                            class="w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-500"
                        />
                        <div
                            class="absolute bottom-2 right-2 bg-white px-2 py-1 font-mono text-xs border-2 border-navy"
                        >
                            STUDENT FAVORITE
                        </div>
                    </div>

                    <!-- Description -->
                    <p
                        id="modal-desc"
                        class="font-mono text-sm text-slate mb-8 leading-relaxed"
                    ></p>

                    <!-- Configuration -->
                    <div class="space-y-6" id="modal-config"></div>
                </div>

                <!-- Commitment Action -->
                <div class="p-4 border-t-4 border-navy bg-white shrink-0">
                    <button
                        onclick="addToOrder()"
                        class="w-full bg-mist text-navy border-hard rounded-full py-4 font-bold uppercase text-lg shadow-hard-sm hover:shadow-hard hover:-translate-y-1 transition-all flex justify-between px-8"
                    >
                        <span>Add to Order</span>
                        <span id="modal-price">$0.00</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Data & Logic -->
        <script
            define:vars={{
                menu,
                menuLoadError,
                squareApplicationId,
                squareLocationId,
                squareEnvironment,
            }}
            is:inline
        >
            // STATE -----------------------------------
            let currentItem = null;
            let cart = [];
            let basePrice = 0;
            let currentModifierGroups = [];
            let selectedModifierOptions = [];
            let checkoutCard = null;
            let checkoutCardReady = false;
            let paymentSubmitting = false;
            const squareCardStyle = {
                input: {
                    backgroundColor: "#d9e6f5",
                    color: "#152433",
                },
                "input::placeholder": {
                    color: "#2a3d52",
                },
                "input.is-focus": {
                    color: "#152433",
                },
                "input.is-error": {
                    color: "#1f2327",
                },
                ".input-container": {
                    borderColor: "#152433",
                    borderRadius: "0px",
                    borderWidth: "3px",
                },
                ".input-container.is-focus": {
                    borderColor: "#152433",
                    borderWidth: "3px",
                },
                ".input-container.is-error": {
                    borderColor: "#1f2327",
                    borderWidth: "3px",
                },
                ".message-text": {
                    color: "#2a3d52",
                },
                ".message-text.is-error": {
                    color: "#1f2327",
                },
                ".message-icon": {
                    color: "#2a3d52",
                },
                ".message-icon.is-error": {
                    color: "#1f2327",
                },
            };
            const itemById = new Map(
                menu.flatMap((category) =>
                    category.items.map((item) => [item.id, item]),
                ),
            );

            // DOM ELEMENTS ----------------------------
            const nav = document.getElementById("category-nav");
            const main = document.getElementById("menu-container");
            const stickyHeader = document.getElementById("order-sticky-header");
            const modal = document.getElementById("product-modal");
            const backdrop = document.getElementById("modal-backdrop");
            const modalContent = document.getElementById("modal-content");
            const modalConfig = document.getElementById("modal-config");
            const reviewOrderButton =
                document.getElementById("review-order-btn");
            const checkoutModal = document.getElementById("checkout-modal");
            const checkoutBackdrop =
                document.getElementById("checkout-backdrop");
            const checkoutContent = document.getElementById("checkout-content");
            const checkoutCloseButton =
                document.getElementById("checkout-close-btn");
            const checkoutItems = document.getElementById("checkout-items");
            const checkoutTotal = document.getElementById("checkout-total");
            const payNowTotal = document.getElementById("pay-now-total");
            const payNowButton = document.getElementById("pay-now-btn");
            const checkoutStatus = document.getElementById("checkout-status");
            const checkoutEmail = document.getElementById("checkout-email");
            const sandboxCardHint = document.getElementById("sandbox-card-hint");

            // INIT ------------------------------------
            function init() {
                renderNav();
                renderMenu();
                attachEvents();
                syncMessagesPluginLayout();
            }

            function renderNav() {
                if (!menu.length) {
                    nav.innerHTML = "";
                    return;
                }

                nav.innerHTML = menu
                    .map(
                        (cat, index) => `
                <button data-target="cat-${index}" class="category-btn border-2 border-navy rounded-full px-4 py-2 font-mono text-sm font-bold uppercase whitespace-nowrap transition-colors hover:bg-fog hover:text-navy ${index === 0 ? "bg-navy text-mist shadow-hard-sm active" : "text-navy"}">
                    ${cat.category}
                </button>
            `,
                    )
                    .join("");
            }

            function renderMenu() {
                if (!menu.length) {
                    main.innerHTML = `
                        <div class="bg-white border-hard p-6 shadow-sm">
                            <h2 class="font-bold text-xl uppercase mb-2 text-navy">Menu Unavailable</h2>
                            <p class="font-mono text-xs text-slate">${menuLoadError || "No catalog items found for this location yet."}</p>
                        </div>
                    `;
                    return;
                }

                main.innerHTML = menu
                    .map(
                        (cat, index) => `
                <div id="cat-${index}" class="mb-12 scroll-mt-6">
                    <h2 class="font-bold text-2xl uppercase mb-6 border-b-4 border-navy inline-block text-navy">${cat.category}</h2>
                    <div class="space-y-4">
                        ${cat.items
                            .map(
                                (item) => `
                            <div data-item-id="${item.id}" class="menu-item group bg-white border-hard p-4 flex gap-4 cursor-pointer active:bg-fog transition-colors shadow-sm hover:shadow-hard-sm">
                                <div class="w-20 h-20 bg-img-bg border-2 border-navy shrink-0 p-1">
                                    <img src="${item.img}" class="w-full h-full object-contain drink-thumb" onerror="this.src='/coffee/no_thumb.png'">
                                </div>
                                <div class="flex flex-col justify-center flex-1 min-w-0">
                                    <h3 class="font-bold text-lg leading-tight mb-1 truncate">${item.name}</h3>
                                    <p class="font-mono text-xs text-slate truncate">${item.desc || "Brewvita Favorite"}</p>
                                    <div class="mt-2 font-mono text-sm font-bold">$${item.price.toFixed(2)}</div>
                                </div>
                                <div class="flex items-center justify-center">
                                    <button class="w-8 h-8 rounded-full border-2 border-navy bg-mist flex items-center justify-center font-bold text-lg group-hover:bg-navy group-hover:text-mist transition-colors">+</button>
                                </div>
                            </div>
                        `,
                            )
                            .join("")}
                    </div>
                </div>
            `,
                    )
                    .join("");
            }

            function attachEvents() {
                nav.addEventListener("click", (event) => {
                    const target = event.target.closest("button[data-target]");
                    if (!target) return;

                    document.querySelectorAll(".category-btn").forEach((button) => {
                        button.classList.remove(
                            "bg-navy",
                            "text-mist",
                            "shadow-hard-sm",
                            "active",
                        );
                        button.classList.add("text-navy");
                    });

                    target.classList.add(
                        "bg-navy",
                        "text-mist",
                        "shadow-hard-sm",
                        "active",
                    );
                    target.classList.remove("text-navy");

                    scrollToCategory(target.dataset.target);
                });

                main.addEventListener("click", (event) => {
                    const menuItem = event.target.closest(".menu-item");
                    if (!menuItem) return;
                    const itemId = menuItem.dataset.itemId;
                    if (!itemId) return;
                    openModal(itemId);
                });

                modalConfig?.addEventListener("click", (event) => {
                    const button =
                        event.target instanceof Element
                            ? event.target.closest("button[data-modifier-action]")
                            : null;
                    if (!button) return;

                    const groupIndex = Number(button.dataset.groupIndex);
                    const optionIndex = Number(button.dataset.optionIndex);
                    if (!Number.isFinite(groupIndex) || !Number.isFinite(optionIndex)) {
                        return;
                    }
                    const action = button.dataset.modifierAction || "toggle";
                    handleModifierAction(groupIndex, optionIndex, action);
                });

                reviewOrderButton?.addEventListener("click", openCheckoutModal);
                checkoutCloseButton?.addEventListener("click", closeCheckoutModal);
                checkoutBackdrop?.addEventListener("click", closeCheckoutModal);
                payNowButton?.addEventListener("click", submitPayment);
                checkoutItems?.addEventListener("click", (event) => {
                    const target =
                        event.target instanceof Element
                            ? event.target.closest("button[data-cart-action]")
                            : null;
                    if (!target) return;

                    const encodedKey = target.dataset.cartKey || "";
                    const action = target.dataset.cartAction || "";
                    removeFromCartGroup(encodedKey, action === "remove-all");
                });
                window.addEventListener(
                    "SqMessagesPluginReady",
                    syncMessagesPluginLayout,
                );
            }

            function syncMessagesPluginLayout() {
                const isProductModalOpen = !modal.classList.contains("hidden");
                const isCheckoutOpen = !checkoutModal.classList.contains("hidden");
                const shouldHideMessages =
                    isProductModalOpen || isCheckoutOpen;
                const shouldShiftMessagesUp =
                    cart.length > 0 && !shouldHideMessages;

                document.body.classList.toggle("messages-hidden", shouldHideMessages);
                document.body.classList.toggle(
                    "messages-shifted",
                    shouldShiftMessagesUp,
                );

                const messagesPlugin = window.__sqMessagesPlugin;
                if (!messagesPlugin) return;
                if (shouldHideMessages) {
                    messagesPlugin.hide?.();
                } else {
                    messagesPlugin.show?.();
                }
            }

            function scrollToCategory(id) {
                const section = document.getElementById(id);
                if (!section) return;
                const stickyOffset = stickyHeader?.offsetHeight || 0;

                const targetTop = Math.max(
                    section.getBoundingClientRect().top
                        + window.scrollY
                        - stickyOffset
                        - 12,
                    0,
                );
                window.scrollTo({
                    top: targetTop,
                    behavior: "smooth",
                });
            }

            // MODAL LOGIC -----------------------------
            function getDefaultModifierSelection(group) {
                const selected = new Map();
                const options = Array.isArray(group?.options) ? group.options : [];
                if (!options.length) return selected;

                const defaultOptions = options.filter((option) => option.onByDefault);
                const maxSelectable = Number.isFinite(group.maxSelected)
                    ? Number(group.maxSelected)
                    : null;

                for (const option of defaultOptions) {
                    const selectedCount = Array.from(selected.values()).reduce(
                        (acc, qty) => acc + Number(qty || 0),
                        0,
                    );
                    if (maxSelectable !== null && selectedCount >= maxSelectable) {
                        break;
                    }
                    selected.set(option.id, 1);
                    if (group.isSingle) break;
                }

                if (!selected.size && group.isSingle) {
                    const preferredOption =
                        options.find(
                            (option) =>
                                /size/i.test(group.name || "") &&
                                /med/i.test(option.name || ""),
                        ) ||
                        (group.required && /size/i.test(group.name || "")
                            ? options[0]
                            : null);
                    if (preferredOption?.id) {
                        selected.set(preferredOption.id, 1);
                    }
                }

                return selected;
            }

            function getSelectedCount(selectionMap) {
                return Array.from((selectionMap || new Map()).values()).reduce(
                    (acc, qty) => acc + Number(qty || 0),
                    0,
                );
            }

            function getGroupSelectionCount(groupIndex) {
                return getSelectedCount(selectedModifierOptions[groupIndex]);
            }

            function getOptionQuantity(groupIndex, optionId) {
                const selectionMap = selectedModifierOptions[groupIndex] || new Map();
                return Number(selectionMap.get(optionId) || 0);
            }

            function getGroupHelperText(group, selectedCount) {
                const hasMax = Number.isFinite(group.maxSelected);
                const maxSelected = hasMax ? Number(group.maxSelected) : null;

                if (!hasMax) {
                    return group.required
                        ? `Required / Min ${group.minSelected}`
                        : "Optional";
                }
                if (group.minSelected === maxSelected) {
                    return `Pick ${maxSelected}`;
                }
                if (group.required) {
                    return `Required / Pick ${group.minSelected}-${maxSelected}`;
                }
                if (maxSelected === 1) {
                    return selectedCount > 0 ? "Selected" : "Optional";
                }
                return `Optional / Pick up to ${maxSelected}`;
            }

            function getModifierAdjustmentLabel(adjustment) {
                const numericAdjustment = Number(adjustment || 0);
                if (numericAdjustment === 0) return "";
                return `${numericAdjustment > 0 ? "+" : "-"}$${Math.abs(numericAdjustment).toFixed(2)}`;
            }

            function renderQuantityOption(
                groupIndex,
                option,
                optionIndex,
                quantity,
            ) {
                const adjustmentLabel = getModifierAdjustmentLabel(
                    option.priceAdjustment,
                );
                const isSelected = quantity > 0;
                return `
                    <div class="border-2 border-navy rounded-2xl p-3 ${isSelected ? "bg-mist" : "bg-white"}">
                        <div class="flex items-start justify-between gap-3">
                            <span class="block text-sm font-bold leading-tight">${option.name}</span>
                            ${adjustmentLabel ? `<span class="block text-[10px] font-mono shrink-0">${adjustmentLabel}</span>` : ""}
                        </div>
                        <div class="mt-3 flex items-center justify-between gap-2">
                            <button
                                class="w-8 h-8 border-2 border-navy rounded-full font-bold text-lg leading-none ${quantity > 0 ? "bg-white" : "bg-fog text-slate"}"
                                data-group-index="${groupIndex}"
                                data-option-index="${optionIndex}"
                                data-modifier-action="dec"
                                ${quantity > 0 ? "" : "disabled"}
                            >
                                -
                            </button>
                            <span class="font-mono text-sm font-bold min-w-8 text-center">${quantity}</span>
                            <button
                                class="w-8 h-8 border-2 border-navy rounded-full font-bold text-lg leading-none bg-white"
                                data-group-index="${groupIndex}"
                                data-option-index="${optionIndex}"
                                data-modifier-action="inc"
                            >
                                +
                            </button>
                        </div>
                    </div>
                `;
            }

            function renderToggleOption(groupIndex, option, optionIndex, isSelected) {
                const adjustmentLabel = getModifierAdjustmentLabel(
                    option.priceAdjustment,
                );
                return `
                    <button
                        class="border-2 border-navy rounded-full p-3 font-mono text-center hover:bg-fog focus:bg-navy focus:text-white transition-colors ${isSelected ? "bg-navy text-white shadow-hard-sm" : ""}"
                        data-group-index="${groupIndex}"
                        data-option-index="${optionIndex}"
                        data-modifier-action="toggle"
                    >
                        <span class="block text-sm font-bold truncate">${option.name}</span>
                        ${adjustmentLabel ? `<span class="block text-[10px] mt-0.5">${adjustmentLabel}</span>` : ""}
                    </button>
                `;
            }

            function renderModifierGroups(item) {
                currentModifierGroups = Array.isArray(item?.modifierGroups)
                    ? item.modifierGroups
                    : [];
                selectedModifierOptions = currentModifierGroups.map((group) =>
                    getDefaultModifierSelection(group),
                );
                renderModifierGroupsUI();
            }

            function renderModifierGroupsUI() {
                if (!modalConfig) return;
                if (!currentModifierGroups.length) {
                    modalConfig.innerHTML = "";
                    return;
                }

                modalConfig.innerHTML = currentModifierGroups
                    .map((group, groupIndex) => {
                        const selectedCount = getGroupSelectionCount(groupIndex);
                        const helperText = getGroupHelperText(group, selectedCount);
                        const allowQuantities = Boolean(group.allowQuantities);
                        const optionGridClass =
                            group.options.length <= 3
                                ? "grid-cols-3"
                                : "grid-cols-2";

                        return `
                            <div>
                                <div class="flex items-center justify-between gap-3 mb-3">
                                    <span class="block font-bold uppercase text-xs tracking-widest text-slate">${group.name}</span>
                                    <span class="font-mono text-[10px] uppercase text-slate">${helperText}</span>
                                </div>
                                <div class="grid ${optionGridClass} gap-3">
                                    ${group.options
                                        .map((option, optionIndex) => {
                                            const quantity = getOptionQuantity(
                                                groupIndex,
                                                option.id,
                                            );
                                            const isSelected = quantity > 0;
                                            if (allowQuantities) {
                                                return renderQuantityOption(
                                                    groupIndex,
                                                    option,
                                                    optionIndex,
                                                    quantity,
                                                );
                                            }
                                            return renderToggleOption(
                                                groupIndex,
                                                option,
                                                optionIndex,
                                                isSelected,
                                            );
                                        })
                                        .join("")}
                                </div>
                            </div>
                        `;
                    })
                    .join("");
            }

            function toggleModifierOption(groupIndex, optionIndex) {
                const group = currentModifierGroups[groupIndex];
                if (!group) return;
                const option = group.options?.[optionIndex];
                if (!option) return;

                const currentSelection = new Map(
                    selectedModifierOptions[groupIndex] || new Map(),
                );
                const currentQuantity = Number(currentSelection.get(option.id) || 0);
                const selectedCount = getSelectedCount(currentSelection);
                const hasMax = Number.isFinite(group.maxSelected);
                const maxSelected = hasMax ? Number(group.maxSelected) : null;

                if (group.allowQuantities) {
                    return;
                }

                if (group.isSingle) {
                    if (currentQuantity > 0 && !group.required) {
                        currentSelection.clear();
                    } else if (currentQuantity <= 0) {
                        currentSelection.clear();
                        currentSelection.set(option.id, 1);
                    }
                } else if (currentQuantity > 0) {
                    if (selectedCount <= group.minSelected) return;
                    currentSelection.delete(option.id);
                } else {
                    if (maxSelected !== null && selectedCount >= maxSelected) return;
                    currentSelection.set(option.id, 1);
                }

                selectedModifierOptions[groupIndex] = currentSelection;
                renderModifierGroupsUI();
                updatePrice();
            }

            function adjustModifierQuantity(groupIndex, optionIndex, delta) {
                const group = currentModifierGroups[groupIndex];
                if (!group) return;
                const option = group.options?.[optionIndex];
                if (!option) return;
                if (!group.allowQuantities) return;

                const currentSelection = new Map(
                    selectedModifierOptions[groupIndex] || new Map(),
                );
                const currentQuantity = Number(currentSelection.get(option.id) || 0);
                const selectedCount = getSelectedCount(currentSelection);
                const hasMax = Number.isFinite(group.maxSelected);
                const maxSelected = hasMax ? Number(group.maxSelected) : null;

                if (delta > 0) {
                    if (maxSelected !== null && selectedCount >= maxSelected) return;
                    currentSelection.set(option.id, currentQuantity + 1);
                } else {
                    if (currentQuantity <= 0) return;
                    const nextQty = currentQuantity - 1;
                    if (nextQty <= 0) {
                        currentSelection.delete(option.id);
                    } else {
                        currentSelection.set(option.id, nextQty);
                    }
                }

                selectedModifierOptions[groupIndex] = currentSelection;
                renderModifierGroupsUI();
                updatePrice();
            }

            function handleModifierAction(groupIndex, optionIndex, action) {
                if (action === "inc") {
                    adjustModifierQuantity(groupIndex, optionIndex, 1);
                    return;
                }
                if (action === "dec") {
                    adjustModifierQuantity(groupIndex, optionIndex, -1);
                    return;
                }
                toggleModifierOption(groupIndex, optionIndex);
            }

            function getSelectedOptionDetails() {
                const selectedOptions = [];
                currentModifierGroups.forEach((group, groupIndex) => {
                    const selectedSet =
                        selectedModifierOptions[groupIndex] || new Map();
                    group.options.forEach((option) => {
                        const quantity = Number(selectedSet.get(option.id) || 0);
                        if (quantity <= 0) return;
                        selectedOptions.push({
                            ...option,
                            quantity,
                            groupId: group.id,
                            groupName: group.name,
                        });
                    });
                });
                return selectedOptions;
            }

            function getModifierSelectionError() {
                for (let index = 0; index < currentModifierGroups.length; index += 1) {
                    const group = currentModifierGroups[index];
                    const selectedCount = getGroupSelectionCount(index);
                    if (selectedCount < group.minSelected) {
                        if (group.minSelected === 1) {
                            return `Please select a ${group.name} option.`;
                        }
                        return `Please select at least ${group.minSelected} ${group.name} options.`;
                    }
                    if (
                        Number.isFinite(group.maxSelected) &&
                        selectedCount > Number(group.maxSelected)
                    ) {
                        return `Please select no more than ${group.maxSelected} ${group.name} options.`;
                    }
                }
                return "";
            }

            window.openModal = function (itemId) {
                const found = itemById.get(itemId);
                if (!found) return;

                currentItem = found;
                basePrice = found.price;

                // Update UI
                document.getElementById("modal-title").innerText = found.name;
                document.getElementById("modal-desc").innerText =
                    found.desc || "A delicious Brewvita classic.";
                document.getElementById("modal-img").src = found.img;
                document.getElementById("modal-img").onerror = function () {
                    this.src = "/coffee/no_thumb.png";
                };

                renderModifierGroups(found);

                updatePrice();

                // Show
                modal.classList.remove("hidden");
                syncMessagesPluginLayout();
                setTimeout(() => {
                    backdrop.classList.remove("opacity-0");
                    modalContent.classList.remove(
                        "translate-y-full",
                        "scale-95",
                        "opacity-0",
                    );
                }, 10);
            };

            window.closeModal = function () {
                backdrop.classList.add("opacity-0");
                modalContent.classList.add(
                    "translate-y-full",
                    "scale-95",
                    "opacity-0",
                );
                setTimeout(() => {
                    modal.classList.add("hidden");
                    syncMessagesPluginLayout();
                }, 300);
            };

            function updatePrice() {
                const final =
                    basePrice +
                    getSelectedOptionDetails().reduce(
                        (acc, option) =>
                            acc +
                            Number(option.priceAdjustment || 0)
                                * Number(option.quantity || 1),
                        0,
                    );
                document.getElementById("modal-price").innerText =
                    `$${final.toFixed(2)}`;
            }

            function getCartLineModifiers(line) {
                if (Array.isArray(line.modifiers)) {
                    const normalized = line.modifiers
                        .map((modifier) => {
                            const id =
                                typeof modifier?.catalog_object_id === "string"
                                    ? modifier.catalog_object_id
                                    : "";
                            const quantity = Math.max(
                                1,
                                Math.trunc(Number(modifier?.quantity || 1) || 1),
                            );
                            if (!id) return null;
                            return {
                                catalog_object_id: id,
                                quantity,
                            };
                        })
                        .filter(Boolean);
                    if (normalized.length) {
                        return normalized.sort((a, b) =>
                            a.catalog_object_id.localeCompare(b.catalog_object_id),
                        );
                    }
                }

                const fallbackIds = Array.isArray(line.modifier_catalog_object_ids)
                    ? line.modifier_catalog_object_ids
                    : [];
                return Array.from(
                    new Set(
                        fallbackIds.filter(
                            (id) => typeof id === "string" && id.length > 0,
                        ),
                    ),
                )
                    .sort((a, b) => a.localeCompare(b))
                    .map((id) => ({
                        catalog_object_id: id,
                        quantity: 1,
                    }));
            }

            function getCartLineKey(line) {
                const modifierKey = getCartLineModifiers(line)
                    .map(
                        (modifier) =>
                            `${modifier.catalog_object_id}x${modifier.quantity}`,
                    )
                    .join(",");
                return `${line.catalog_object_id || ""}::${modifierKey}`;
            }

            function getCartTotal() {
                return cart.reduce((acc, line) => acc + Number(line.price || 0), 0);
            }

            function setCheckoutStatus(message, isError = false) {
                if (!checkoutStatus) return;
                checkoutStatus.innerText = message || "";
                checkoutStatus.classList.toggle("text-red-700", Boolean(message && isError));
                checkoutStatus.classList.toggle("text-green-700", Boolean(message && !isError));
                checkoutStatus.classList.toggle("text-slate", !message);
            }

            function setPayNowLoading(isLoading) {
                if (!payNowButton) return;

                paymentSubmitting = isLoading;
                const buttonLabel = payNowButton.querySelector("span");
                if (buttonLabel) {
                    buttonLabel.innerText = isLoading ? "Processing..." : "Pay Now";
                }
                syncPayNowButtonState();
            }

            function syncPayNowButtonState() {
                if (!payNowButton) return;
                const isDisabled = paymentSubmitting || cart.length === 0;
                payNowButton.disabled = isDisabled;
                payNowButton.classList.toggle("opacity-70", isDisabled);
                payNowButton.classList.toggle("cursor-not-allowed", isDisabled);
            }

            function removeFromCartGroup(encodedKey, removeAll = false) {
                const groupKey = decodeURIComponent(encodedKey || "");
                if (!groupKey) return;

                if (removeAll) {
                    cart = cart.filter((line) => getCartLineKey(line) !== groupKey);
                } else {
                    const removeIndex = cart.findIndex(
                        (line) => getCartLineKey(line) === groupKey,
                    );
                    if (removeIndex >= 0) {
                        cart.splice(removeIndex, 1);
                    }
                }

                setCheckoutStatus("");
                updateCartUI();
                renderCheckoutSummary();
            }

            function renderCheckoutSummary() {
                const grouped = new Map();

                cart.forEach((line) => {
                    const key = getCartLineKey(line);
                    const existing = grouped.get(key);
                    if (existing) {
                        existing.quantity += Number(line.quantity || 1);
                        existing.total += Number(line.price || 0);
                        return;
                    }

                    grouped.set(key, {
                        key,
                        label: line.display_name || line.name || "Item",
                        quantity: Number(line.quantity || 1),
                        total: Number(line.price || 0),
                    });
                });

                const rows = Array.from(grouped.values());
                if (!rows.length) {
                    checkoutItems.innerHTML = `
                        <div class="bg-fog border-2 border-navy px-3 py-2 font-mono text-xs text-slate">
                            Your cart is empty.
                        </div>
                    `;
                } else {
                    checkoutItems.innerHTML = rows
                        .map((row) => {
                            const encodedKey = encodeURIComponent(row.key);
                            return `
                                <div class="bg-fog border-2 border-navy px-3 py-2 flex justify-between items-center gap-3">
                                    <div class="min-w-0 flex-1">
                                        <p class="font-bold text-sm truncate">${row.label}</p>
                                        <p class="font-mono text-xs text-slate">Qty ${row.quantity}</p>
                                    </div>
                                    <div class="flex flex-col items-end gap-2 shrink-0">
                                        <p class="font-mono font-bold text-sm">$${row.total.toFixed(2)}</p>
                                        <div class="flex items-center gap-2">
                                            ${
                                                row.quantity > 1
                                                    ? `<button data-cart-action="remove-one" data-cart-key="${encodedKey}" class="border-2 border-navy px-2 py-0.5 rounded-full text-[11px] font-bold uppercase leading-4 hover:bg-fog active:bg-mist transition-colors">-1</button>`
                                                    : ""
                                            }
                                            <button data-cart-action="remove-all" data-cart-key="${encodedKey}" class="border-2 border-navy px-2 py-0.5 rounded-full text-[11px] font-bold uppercase leading-4 hover:bg-fog active:bg-mist transition-colors">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        })
                        .join("");
                }

                const total = getCartTotal();
                checkoutTotal.innerText = `$${total.toFixed(2)}`;
                payNowTotal.innerText = `$${total.toFixed(2)}`;
                syncPayNowButtonState();
            }

            async function ensureCardReady() {
                if (checkoutCardReady) return true;
                if (!squareApplicationId || !squareLocationId) {
                    setCheckoutStatus(
                        "Square app ID or location ID is missing. Check environment keys.",
                        true,
                    );
                    return false;
                }
                if (!window.Square || typeof window.Square.payments !== "function") {
                    setCheckoutStatus(
                        "Square payment form failed to load. Refresh and try again.",
                        true,
                    );
                    return false;
                }

                try {
                    const payments = window.Square.payments(
                        squareApplicationId,
                        squareLocationId,
                    );
                    checkoutCard = await payments.card({
                        style: squareCardStyle,
                    });
                    await checkoutCard.attach("#card-container");
                    checkoutCardReady = true;
                    setCheckoutStatus("");
                    return true;
                } catch (error) {
                    setCheckoutStatus(
                        error instanceof Error
                            ? error.message
                            : "Unable to initialize payment form.",
                        true,
                    );
                    return false;
                }
            }

            async function openCheckoutModal() {
                if (!cart.length) {
                    window.alert("Add at least one item before checking out.");
                    return;
                }

                renderCheckoutSummary();
                setCheckoutStatus("");
                sandboxCardHint?.classList.toggle(
                    "hidden",
                    squareEnvironment === "production",
                );

                checkoutModal.classList.remove("hidden");
                syncMessagesPluginLayout();
                setTimeout(() => {
                    checkoutBackdrop.classList.remove("opacity-0");
                    checkoutContent.classList.remove(
                        "translate-y-full",
                        "scale-95",
                        "opacity-0",
                    );
                }, 10);

                await ensureCardReady();
            }

            function closeCheckoutModal() {
                checkoutBackdrop.classList.add("opacity-0");
                checkoutContent.classList.add(
                    "translate-y-full",
                    "scale-95",
                    "opacity-0",
                );
                setTimeout(() => {
                    checkoutModal.classList.add("hidden");
                    syncMessagesPluginLayout();
                }, 300);
            }

            async function submitPayment() {
                if (paymentSubmitting) return;
                if (!cart.length) {
                    setCheckoutStatus("Your cart is empty.", true);
                    return;
                }

                const cardReady = await ensureCardReady();
                if (!cardReady || !checkoutCard) return;

                setPayNowLoading(true);
                setCheckoutStatus("");

                try {
                    const tokenResult = await checkoutCard.tokenize();
                    if (tokenResult.status !== "OK" || !tokenResult.token) {
                        const tokenError = tokenResult.errors?.[0];
                        throw new Error(
                            tokenError?.message || "Card tokenization failed.",
                        );
                    }

                    const response = await fetch("/api/checkout", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            cart,
                            sourceId: tokenResult.token,
                            buyerEmailAddress: checkoutEmail?.value?.trim() || undefined,
                        }),
                    });
                    const payload = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(
                            payload?.error || "Payment failed. Please try again.",
                        );
                    }

                    const paidAmount = Number(payload?.totalMoney?.amount);
                    const paidDisplay = Number.isFinite(paidAmount)
                        ? `$${(paidAmount / 100).toFixed(2)}`
                        : checkoutTotal.innerText;
                    setCheckoutStatus("Payment complete.", false);
                    if (squareEnvironment !== "production") {
                        window.alert(
                            `Payment complete. Order ${payload.orderId} for ${paidDisplay}.`,
                        );
                    }

                    cart = [];
                    updateCartUI();
                    renderCheckoutSummary();
                    closeCheckoutModal();
                } catch (error) {
                    setCheckoutStatus(
                        error instanceof Error
                            ? error.message
                            : "Unable to complete payment.",
                        true,
                    );
                } finally {
                    setPayNowLoading(false);
                }
            }

            window.addToOrder = function () {
                if (!currentItem) return;

                const selectionError = getModifierSelectionError();
                if (selectionError) {
                    window.alert(selectionError);
                    return;
                }

                const selectedOptions = getSelectedOptionDetails();
                const finalPrice =
                    basePrice +
                    selectedOptions.reduce(
                        (acc, option) =>
                            acc +
                            Number(option.priceAdjustment || 0)
                                * Number(option.quantity || 1),
                        0,
                    );
                const modifiers = selectedOptions
                    .filter((option) => option.sourceType === "MODIFIER")
                    .map((option) => ({
                        catalog_object_id: option.id,
                        quantity: String(
                            Math.max(
                                1,
                                Math.trunc(Number(option.quantity || 1) || 1),
                            ),
                        ),
                    }));
                const selectedVariation =
                    selectedOptions.find(
                        (option) => option.sourceType === "VARIATION",
                    ) || null;
                const selectedVariationId =
                    selectedVariation?.variationId ||
                    selectedVariation?.id ||
                    currentItem.variationId;
                const selectedOptionNames = selectedOptions
                    .map((option) => {
                        const quantity = Number(option.quantity || 1);
                        return quantity > 1
                            ? `${option.name} x${quantity}`
                            : option.name;
                    })
                    .filter(Boolean);
                const displayName = selectedOptionNames.length
                    ? `${currentItem.name} (${selectedOptionNames.join(", ")})`
                    : currentItem.name;

                cart.push({
                    name: currentItem.name,
                    display_name: displayName,
                    catalog_object_id: selectedVariationId,
                    modifiers,
                    modifier_catalog_object_ids: modifiers.map(
                        (modifier) => modifier.catalog_object_id,
                    ),
                    quantity: 1,
                    price: finalPrice,
                });
                updateCartUI();
                closeModal();
            };

            function updateCartUI() {
                const count = cart.length;
                const total = cart.reduce(
                    (acc, curr) => acc + Number(curr.price || 0),
                    0,
                );

                document.getElementById("cart-count").innerText = count;
                document.getElementById("cart-total").innerText =
                    `$${total.toFixed(2)}`;

                if (count > 0) {
                    document
                        .getElementById("cart-bar")
                        .classList.remove("translate-y-full");
                } else {
                    document
                        .getElementById("cart-bar")
                        .classList.add("translate-y-full");
                }

                syncPayNowButtonState();
                syncMessagesPluginLayout();
            }

            // Run
            init();
        </script>
        <script
            is:inline
            id="sq-messages-plugin"
            src="https://conversations-production-f.squarecdn.com/v2/messages-plugin.js"
            data-seller-key="LTGK4HYN3BCF4"
            data-auto-show="false"
            async
        ></script>
        <script is:inline>
            window.addEventListener("MessagesPluginReady", () => {
                if (typeof window.MessagesPlugin !== "function") return;

                const messagesPlugin = new window.MessagesPlugin({
                    color: "#b9d3ea",
                    businessName: "Brewvita",
                    locationName: "Brewvita",
                    responseTimeText: "We'll respond as soon as we can",
                });
                messagesPlugin.show();
                window.__sqMessagesPlugin = messagesPlugin;
                window.dispatchEvent(new CustomEvent("SqMessagesPluginReady"));
            });
        </script>
        <!-- Redeploy trigger -->
    </body>
</html>
